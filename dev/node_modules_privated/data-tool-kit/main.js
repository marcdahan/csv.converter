/* jshint -W061, -W098 */
var jsdom = require("jsdom");
var dom = new jsdom.JSDOM();
var $ = require("jquery")(dom.window);
var json2csv = require('json2csv').Parser;

var DataToolKit = function() {
    this.fileName = null;
    this.headers = null;
    this.rawJson = null;
    this.refinedJson = null;
    this.refinedArray = null;
    this.csv = null;
    this.init();
};

DataToolKit.prototype.init = function() {
    var variables = [];
    for (var key in this) {
        if (this[key] === null) {
            variables.push(key);
        }
    }
    $.each(variables, $.proxy(function(index, value) {
        var standardized = value.charAt(0).toUpperCase() + value.slice(1);
        eval('this.set' + standardized + ' = function(' + value + ' ) { this.' + value + ' = ' + value + '; }');
        eval('this.get' + standardized + ' = function() { return this.' + value + '; }');
        eval('this.reset' + standardized + ' = function(' + value + ' ) { this.' + value + ' = ' + value + '; }');
    }, this));
};

DataToolKit.prototype.convertJson2CSV = function(headers, fileName, json) {
	if (headers && this.isArray(headers)) {
        this.setHeaders(headers);
        this.setFileName(fileName);
        this.resetRefinedJson({});
        this.resetCsv(null);
        this.convertJsonToRefinedJson(json);
        this.convertRefinedJson2CSV();
        return this.getRefinedJson();
    } else {
        throw "bad parameter";
    }
};

DataToolKit.prototype.convertJsonToRefinedArray = function(json, path) {
    if (!this.isJSON(json)) {
        throw "bad parameter" + JSON.stringify(json);
    }
    $.each(json, $.proxy(function(key, value) {
        if ($.type(value) === "object") {
            path = (path ? path + '.' : '');
            this.convertJsonToRefinedArray(value, path + key);
        } else if ($.type(value) === "string") {
            this.refinedArray.push([path, key, "" + value]);
        }
    }, this));
};

DataToolKit.prototype.convertJsonToRefinedJson = function(json, path) {
    if (!this.isJSON(json)) {
        throw "bad parameter" + JSON.stringify(json);
    }
    $.each(json, $.proxy(function(key, value) {
        if ($.type(value) === "object") {
            path = (path ? path + '.' : '');
            this.convertJsonToRefinedJson(value, path + key);
        } else if ($.type(value) === "string") {
            this.refinedJson[path] = {};
            this.refinedJson[path][key] = value;
        }
    }, this));
};

DataToolKit.prototype.convertRefinedJson2CSV = function() {
    var json2csvParser = new json2csv(this.getHeaders());
    this.setCsv(json2csvParser.parse(this.getRefinedJson()));
};

DataToolKit.prototype.isJSON = function(json) {
    var bool = false;
    if (Object.prototype.toString.call(json) === '[object Object]') {
        bool = true;
    }
    return bool;
};

DataToolKit.prototype.isArray = function(arr) {
    var bool = false;
    if (Object.prototype.toString.call(arr) === '[object Array]') {
        bool = true;
    }
    return bool;
};

module.exports = DataToolKit;
